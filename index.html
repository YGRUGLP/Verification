<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®‰å…¨éªŒè¯ç¦»è°±ç‰ˆ</title>
    <!-- å¤–éƒ¨æ ·å¼è¡¨ï¼Œé€‚ç”¨äº GitHub Pages çš„ /Verification/style.css -->
    <link rel="stylesheet" href="/Verification/style.css">
</head>
<body>
    <div class="card">
        <!-- é¦–é¡µ -->
        <div id="view-home" class="view-section" style="display:block;">
            <div class="alert-banner">
                <strong>âš ï¸ å®‰å…¨éªŒè¯</strong><br>
                æ£€æµ‹åˆ°å¼‚å¸¸æµé‡ã€‚è¯·å®Œæˆä»¥ä¸‹å¤šé‡éªŒè¯ã€‚
            </div>
            <div class="captcha-box" onclick="startLevel1()">
                <div style="display:flex; align-items:center;">
                    <div class="cb-fake" id="fake-cb"></div>
                    <span style="font-size:14px;">ç‚¹å‡»å¼€å§‹éªŒè¯</span>
                </div>
                <img src="https://www.gstatic.com/recaptcha/api2/logo_48.png" width="30" style="opacity:0.6">
            </div>
        </div>

        <!-- è¿åŠ¨æƒé™ -->
        <div id="view-perm-motion" class="view-section">
            <span class="icon-large">ğŸ“²</span>
            <h2>æ­¥éª¤ 2/5: è¿åŠ¨æ ¡å‡†</h2>
            <div class="hint-box">
                æ•°å­—éªŒè¯é€šè¿‡ã€‚<br>
                è¯·å…è®¸è®¿é—®ä¼ æ„Ÿå™¨ï¼Œä»¥è¿›è¡Œç‰©ç†å¹³è¡¡æµ‹è¯•ã€‚
            </div>
            <button class="btn" onclick="requestMotionPermission()">å…è®¸å¹¶å¼€å§‹</button>
        </div>

        <!-- éº¦å…‹é£æƒé™ -->
        <div id="view-perm-mic" class="view-section">
            <span class="icon-large">ğŸ™ï¸</span>
            <h2>æ­¥éª¤ 3/5: ç¯å¢ƒå£°çº¹</h2>
            <div class="hint-box">
                é‡åŠ›æµ‹è¯•é€šè¿‡ã€‚<br>
                éœ€è¦éº¦å…‹é£æ£€æµ‹ç¯å¢ƒå™ªéŸ³ã€‚
                <br><strong>âš ï¸ å…¨ç¨‹ç¦»çº¿å¤„ç†ï¼Œä¸ä¸Šä¼ å½•éŸ³ã€‚</strong>
            </div>
            <button class="btn" onclick="reqMic()">æˆæƒå¹¶ç»§ç»­</button>
        </div>

        <!-- æ‘„åƒå¤´æƒé™ -->
        <div id="view-perm-camera" class="view-section">
            <span class="icon-large">ğŸ“·</span>
            <h2>æ­¥éª¤ 4/5: è‰²å½©è¯†åˆ«</h2>
            <div class="hint-box">
                âš ï¸å¯æ–­ç½‘éªŒè¯âš ï¸<br>
                æœ€åä¸€æ­¥éœ€è¦æ‘„åƒå¤´è¿›è¡Œé¢œè‰²åŒ¹é…ã€‚
            </div>
            <button class="btn" onclick="reqCamera()">æˆæƒå¹¶å¼€å§‹</button>
        </div>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="view-game" class="view-section">
            <div class="status-bar" id="status-text">åŠ è½½ä¸­...</div>

            <!-- å…³å¡1 -->
            <div id="stage-1" class="game-stage">
                <div style="font-size:12px; color:#999; margin-bottom:5px;">å…³å¡ 1: è§†è§‰éªŒè¯</div>
                <canvas id="captcha-canvas" class="captcha-canvas" width="300" height="100"></canvas>
                <div class="input-row">
                    <input type="text" id="captcha-input" class="captcha-input" placeholder="è¾“å…¥å›¾ä¸­æ•°å­—" maxlength="6">
                    <button class="btn" style="width: auto; margin: 0;" onclick="checkCaptcha()">ç¡®è®¤</button>
                </div>
                <p style="font-size:12px; margin-top:5px; cursor:pointer; color:var(--primary);" onclick="initCaptcha()">çœ‹ä¸æ¸…ï¼Ÿæ¢ä¸€å¼ </p>
            </div>

            <!-- å…³å¡2 æ°´å¹³å¹³è¡¡ (2%å®½åº¦) -->
            <div id="stage-2" class="game-stage">
                <div style="font-size:12px; color:#999; margin-bottom:5px;">å…³å¡ 2: æ°´å¹³å¹³è¡¡</div>
                <div class="track-h">
                    <div class="target-zone" id="t-2" style="height:100%; top:0;"></div>
                    <div class="ball" id="b-2" style="top:50%;"></div>
                </div>
            </div>

            <!-- å…³å¡3 ç²¾å‡†å®šä½ (2%x2%æ–¹æ¡†) -->
            <div id="stage-3" class="game-stage">
                <div style="font-size:12px; color:#999; margin-bottom:5px;">å…³å¡ 3: ç²¾å‡†å®šä½</div>
                <div class="box-2d">
                    <div class="target-zone" id="t-3"></div>
                    <div class="ball" id="b-3"></div>
                </div>
            </div>

            <!-- å…³å¡4 å£°å‹æ§åˆ¶ (ååŠæ®µ) -->
            <div id="stage-4" class="game-stage">
                <div style="font-size:12px; color:#999; margin-bottom:5px;">å…³å¡ 4: å£°å‹æ§åˆ¶</div>
                <p style="font-size:12px; margin-bottom:10px;">è¯·æŒç»­å‘å‡ºå£°éŸ³ï¼Œå°†è“è‰²æ¡<b>ç¨³å®š</b>åœ¨ç»¿è‰²åŒºåŸŸã€‚</p>
                <div class="mic-container">
                    <div class="mic-target" id="t-mic"></div>
                    <div class="mic-bar" id="bar-mic"></div>
                </div>
                <div style="margin-top:5px; font-size:12px; color:#aaa;">å¹³æ»‘éŸ³é‡: <span id="vol-val">0</span>%</div>
            </div>

            <!-- å…³å¡5 è‰²å½©åœç•™ (é™3æ¬¡åˆ·æ–°) -->
            <div id="stage-5" class="game-stage">
                <div style="font-size:12px; color:#999; margin-bottom:5px;">å…³å¡ 5: è‰²å½©åœç•™ (3ç§’)</div>
                <div class="cam-container">
                    <video id="video5" playsinline autoplay muted></video>
                    <div class="aim-dot"></div>
                </div>
                <div class="color-row">
                    <span style="font-weight:500;">ğŸ¯ ç›®æ ‡</span>
                    <div class="swatch" id="targetSwatch5" style="background:#4a90e2;"></div>
                </div>
                <div class="color-row">
                    <span style="font-weight:500;">ğŸ” å½“å‰</span>
                    <div class="swatch" id="detectSwatch5" style="background:#333;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin:6px 0;">
                    <span class="diff-badge" id="diffDisplay5">å·®å€¼ --</span>
                    <div>
                        <button class="btn-small" id="refreshColorBtn5">ğŸ² æ–°ç›®æ ‡</button>
                        <span class="refresh-counter" id="refreshCounter5">å‰©ä½™3æ¬¡</span>
                    </div>
                </div>
            </div>

            <div class="progress-bg">
                <div class="progress-fill" id="main-progress"></div>
            </div>
        </div>

        <!-- æˆåŠŸé¡µé¢ (å«è®¾å¤‡ç ) -->
        <div id="view-success" class="view-section">
            <div class="check-icon">âœ…</div>
            <h2>éªŒè¯é€šè¿‡</h2>
            <p>æ­å–œï¼Œæ‚¨å·²é€šè¿‡æ‰€æœ‰ 5 é¡¹éªŒè¯ã€‚</p>

            <div class="device-box">
                <div class="device-label">ğŸ” è®¾å¤‡ç  (åŸºäºå½“å‰ç½‘ç»œ)</div>
                <div class="device-code" id="deviceCodeDisplay">è·å–ä¸­...</div>
                <div class="device-note">åŸºäºå½“å‰ç½‘ç»œè®¡ç®—ï¼Œå¯èƒ½å› ç½‘ç»œå˜åŒ–è€Œæ”¹å˜</div>
            </div>

            <button class="btn" onclick="location.reload()">é‡æ–°æµ‹è¯•</button>
        </div>
    </div>

    <script>
        // --- å…¨å±€çŠ¶æ€ ---
        let currentLevel = 0; 
        let holdTime = 0;
        const TARGET_TIME = 2000; // å‰4å…³ 2ç§’
        const COLOR_HOLD_TIME = 3000; // ç¬¬5å…³ 3ç§’
        let isGameRunning = false;

        // ä¼ æ„Ÿå™¨æ•°æ® (ç”±ç®€åŒ–ç‰ˆé™€èºä»ªæ›´æ–°)
        let tiltX = 0, tiltY = 0;
        let player = { x: 50, y: 50 };
        let target = { x: 0, y: 0, w: 20, h: 20 };
        
        // éªŒè¯ç æ•°æ®
        let captchaCode = "";

        // éŸ³é¢‘æ•°æ®
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let micTargetRange = { min: 40, max: 70 };
        let currentSmoothVol = 0; 
        const SMOOTHING_FACTOR = 0.05;

        // æ‘„åƒå¤´ç›¸å…³
        let video5 = document.getElementById('video5');
        let canvas5 = document.createElement('canvas');
        canvas5.width = 32;
        canvas5.height = 32;
        let ctx5 = canvas5.getContext('2d');
        let targetColor5 = { r: 255, g: 100, b: 100 };
        let currentColor5 = { r: 0, g: 0, b: 0 };
        let colorThreshold = 75;
        let cameraStream = null;

        // ç¬¬äº”å…³åˆ·æ–°æ¬¡æ•°é™åˆ¶
        let refreshCount5 = 3;

        // è·³è½¬å®šæ—¶å™¨
        let redirectTimer = null;

        // DOM å…ƒç´ 
        const ui = {
            home: document.getElementById('view-home'),
            permMotion: document.getElementById('view-perm-motion'),
            permMic: document.getElementById('view-perm-mic'),
            permCamera: document.getElementById('view-perm-camera'),
            game: document.getElementById('view-game'),
            success: document.getElementById('view-success'),
            status: document.getElementById('status-text'),
            progress: document.getElementById('main-progress'),
            stages: [
                null,
                document.getElementById('stage-1'),
                document.getElementById('stage-2'),
                document.getElementById('stage-3'),
                document.getElementById('stage-4'),
                document.getElementById('stage-5')
            ],
            canvas: document.getElementById('captcha-canvas'),
            input: document.getElementById('captcha-input'),
            b2: document.getElementById('b-2'), t2: document.getElementById('t-2'),
            b3: document.getElementById('b-3'), t3: document.getElementById('t-3'),
            micBar: document.getElementById('bar-mic'), tMic: document.getElementById('t-mic'),
            volText: document.getElementById('vol-val'),
            targetSwatch5: document.getElementById('targetSwatch5'),
            detectSwatch5: document.getElementById('detectSwatch5'),
            diffDisplay5: document.getElementById('diffDisplay5'),
            refreshColorBtn5: document.getElementById('refreshColorBtn5'),
            refreshCounter5: document.getElementById('refreshCounter5'),
            deviceCode: document.getElementById('deviceCodeDisplay')
        };

        function switchView(viewElement) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            viewElement.style.display = 'block';
        }

        // ========== å…³å¡1: æ•°å­—éªŒè¯ ==========
        function startLevel1() {
            document.getElementById('fake-cb').style.background = "#ccc";
            setTimeout(() => {
                switchView(ui.game);
                currentLevel = 1;
                ui.progress.style.width = '10%';
                ui.stages[1].style.display = 'block';
                ui.stages[2].style.display = 'none';
                ui.stages[3].style.display = 'none';
                ui.stages[4].style.display = 'none';
                ui.stages[5].style.display = 'none';
                ui.status.innerText = "è¯·è¾“å…¥å›¾ç‰‡ä¸­çš„æ•°å­—";
                ui.status.style.background = "#e2e3e5";
                ui.status.style.color = "#383d41";
                initCaptcha();
            }, 300);
        }

        function initCaptcha() {
            const ctx = ui.canvas.getContext('2d');
            const w = ui.canvas.width;
            const h = ui.canvas.height;
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0,0,w,h);

            captchaCode = Math.floor(1000 + Math.random() * 9000).toString(); // 4ä½æ•°å­—
            
            ctx.font = 'bold 60px Arial';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            for (let i = 0; i < captchaCode.length; i++) {
                ctx.save();
                let x = (w / captchaCode.length) * (i + 0.5);
                let y = h / 2;
                let angle = (Math.random() - 0.5) * 0.4;
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.fillStyle = '#333';
                ctx.fillText(captchaCode[i], 0, 0);
                ctx.restore();
            }

            // éšæœºé€æ˜é®æŒ¡ç‰©
            for (let i = 0; i < 7; i++) {
                ctx.beginPath();
                let r = Math.random() * 30 + 10;
                let cx = Math.random() * w;
                let cy = Math.random() * h;
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                let red = Math.floor(Math.random()*255);
                let green = Math.floor(Math.random()*255);
                let blue = Math.floor(Math.random()*255);
                ctx.fillStyle = `rgba(${red}, ${green}, ${blue}, 0.3)`;
                ctx.fill();
            }

            // å¹²æ‰°çº¿
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random()*w, Math.random()*h);
                ctx.lineTo(Math.random()*w, Math.random()*h);
                ctx.strokeStyle = `rgba(0,0,0, 0.2)`;
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            ui.input.value = '';
            ui.input.focus();
        }

        function checkCaptcha() {
            if (ui.input.value === captchaCode) {
                switchView(ui.permMotion);
            } else {
                alert("éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•");
                initCaptcha();
            }
        }

        // ========== é™€èºä»ªæƒé™è¯·æ±‚ ==========
        function requestMotionPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            startLevel2();
                        } else {
                            alert('éœ€è¦é™€èºä»ªæƒé™æ‰èƒ½ç»§ç»­');
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                startLevel2();
            }
        }

        function handleOrientation(event) {
            if (event.gamma !== null) {
                tiltX = Math.max(-30, Math.min(30, event.gamma));
            }
            if (event.beta !== null) {
                tiltY = Math.max(20, Math.min(80, event.beta));
            }
        }

        // éº¦å…‹é£æƒé™
        async function reqMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                startLevel4();

            } catch (e) {
                console.error(e);
                alert("éœ€è¦éº¦å…‹é£æƒé™");
            }
        }

        // æ‘„åƒå¤´æƒé™
        async function reqCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { ideal: 'environment' } } 
                });
                cameraStream = stream;
                if (video5) {
                    video5.srcObject = stream;
                    await video5.play();
                }
                startLevel5();
            } catch (e) {
                console.error(e);
                alert("éœ€è¦æ‘„åƒå¤´æƒé™");
            }
        }

        // ========== å…³å¡2 (2%å®½åº¦) ==========
        function startLevel2() {
            switchView(ui.game);
            currentLevel = 2;
            holdTime = 0;
            ui.progress.style.width = '25%';

            ui.stages[1].style.display = 'none';
            ui.stages[2].style.display = 'block';
            ui.stages[3].style.display = 'none';
            ui.stages[4].style.display = 'none';
            ui.stages[5].style.display = 'none';

            ui.status.innerText = "è¯·å·¦å³å€¾æ–œæ‰‹æœºå¯¹å‡†ç»¿è‰²åŒºåŸŸ";
            
            let w = 2;  // 2% å®½åº¦
            target = { x: Math.random()*(100-w), y: 0, w: w, h: 100 };
            ui.t2.style.left = target.x + '%';
            ui.t2.style.width = target.w + '%';

            if(!isGameRunning) {
                isGameRunning = true;
                requestAnimationFrame(gameLoop);
            }
        }

        // ========== å…³å¡3 (2%x2%æ–¹æ¡†) ==========
        function startLevel3() {
            currentLevel = 3;
            holdTime = 0;
            ui.progress.style.width = '50%';
            
            ui.stages[2].style.display = 'none';
            ui.stages[3].style.display = 'block';

            ui.status.innerText = "è¯·å°†çƒç§»å…¥æ–¹æ¡†å†…";
            
            let w = 2, h = 2;  // 2% æ–¹æ¡†
            target = { x: Math.random()*(90-w)+5, y: Math.random()*(90-h)+5, w:w, h:h };
            ui.t3.style.left = target.x + '%';
            ui.t3.style.top = target.y + '%';
            ui.t3.style.width = target.w + '%';
            ui.t3.style.height = target.h + '%';
        }

        function pauseForMic() {
            isGameRunning = false;
            switchView(ui.permMic);
        }

        // ========== å…³å¡4 (ååŠæ®µéšæœº) ==========
        function startLevel4() {
            switchView(ui.game);
            currentLevel = 4;
            holdTime = 0;
            ui.progress.style.width = '75%';
            currentSmoothVol = 0;

            ui.stages[1].style.display = 'none';
            ui.stages[2].style.display = 'none';
            ui.stages[3].style.display = 'none';
            ui.stages[4].style.display = 'block';
            ui.stages[5].style.display = 'none';

            let rangeWidth = 20; 
            // ååŠæ®µï¼šmin ä» 50 åˆ° 80 éšæœº
            let rangeStart = Math.random() * (80 - 50) + 50; // 50~80
            micTargetRange = { min: rangeStart, max: rangeStart + rangeWidth };

            ui.status.innerText = "è¯·æ§åˆ¶å£°éŸ³å¤§å°åœ¨ç»¿è‰²åŒºåŸŸå†…";
            ui.tMic.style.left = micTargetRange.min + '%';
            ui.tMic.style.width = (micTargetRange.max - micTargetRange.min) + '%';
            
            isGameRunning = true;
            requestAnimationFrame(gameLoop);
        }

        function gotoCameraPermission() {
            isGameRunning = false;
            if (audioContext) audioContext.close();
            switchView(ui.permCamera);
        }

        // ========== å…³å¡5 (é™3æ¬¡åˆ·æ–°) ==========
        function startLevel5() {
            switchView(ui.game);
            currentLevel = 5;
            holdTime = 0;
            ui.progress.style.width = '75%';

            ui.stages[1].style.display = 'none';
            ui.stages[2].style.display = 'none';
            ui.stages[3].style.display = 'none';
            ui.stages[4].style.display = 'none';
            ui.stages[5].style.display = 'block';

            ui.status.innerText = "å¯¹å‡†ç›®æ ‡é¢œè‰²å¹¶ä¿æŒ3ç§’";
            ui.status.style.background = "#fff3cd";
            ui.status.style.color = "#856404";

            // åˆå§‹åŒ–åˆ·æ–°æ¬¡æ•°
            refreshCount5 = 3;
            ui.refreshCounter5.innerText = `å‰©ä½™${refreshCount5}æ¬¡`;
            ui.refreshColorBtn5.disabled = false;

            randomTargetColor5();
            ui.refreshColorBtn5.onclick = function() {
                if (refreshCount5 > 0) {
                    randomTargetColor5();
                    refreshCount5--;
                    ui.refreshCounter5.innerText = `å‰©ä½™${refreshCount5}æ¬¡`;
                } else {
                    alert("æ‚¨å·²ä½¿ç”¨å®Œæ¬¡æ•°ï¼");
                    ui.refreshColorBtn5.disabled = true;
                }
            };

            if (!isGameRunning) {
                isGameRunning = true;
                requestAnimationFrame(gameLoop);
            }
        }

        function randomTargetColor5() {
            targetColor5 = {
                r: Math.floor(Math.random() * 256),
                g: Math.floor(Math.random() * 256),
                b: Math.floor(Math.random() * 256)
            };
            ui.targetSwatch5.style.backgroundColor = `rgb(${targetColor5.r}, ${targetColor5.g}, ${targetColor5.b})`;
            holdTime = 0;
        }

        function colorDistance(c1, c2) {
            let dr = c1.r - c2.r;
            let dg = c1.g - c2.g;
            let db = c1.b - c2.b;
            return Math.sqrt(dr*dr + dg*dg + db*db);
        }

        function extractCenterColor5() {
            if (!video5 || video5.readyState < 2) return { r:0, g:0, b:0 };
            try {
                ctx5.drawImage(video5, 0, 0, canvas5.width, canvas5.height);
                let data = ctx5.getImageData(0, 0, canvas5.width, canvas5.height).data;
                let r=0,g=0,b=0,count=0;
                for (let y=10; y<22; y++) {
                    for (let x=10; x<22; x++) {
                        let idx = (y*canvas5.width + x)*4;
                        r += data[idx];
                        g += data[idx+1];
                        b += data[idx+2];
                        count++;
                    }
                }
                return { r: r/count, g: g/count, b: b/count };
            } catch(e) {
                return { r:0, g:0, b:0 };
            }
        }

        // ========== æ¸¸æˆå¾ªç¯ ==========
        function getRawMicVolume() {
            if (!analyser || !dataArray) return 0;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let v of dataArray) sum += v;
            let avg = sum / dataArray.length;
            return Math.min(Math.round(avg * 2.5), 100);
        }

        function gameLoop() {
            if (!isGameRunning) return;

            let hit = false;

            // å…³å¡2&3
            if (currentLevel === 2 || currentLevel === 3) {
                let tx = tiltX; if(tx<-30)tx=-30; if(tx>30)tx=30;
                let targetX = (tx+30)*100/60;
                
                let targetY = player.y;
                if (currentLevel === 3) {
                    let ty = tiltY; if(ty<20)ty=20; if(ty>80)ty=80;
                    targetY = (ty-20)*100/60;
                }

                player.x += (targetX - player.x) * 0.1;
                player.y += (targetY - player.y) * 0.1;

                let inX = player.x > target.x && player.x < target.x+target.w;
                let inY = true;
                if (currentLevel === 3) inY = player.y > target.y && player.y < target.y+target.h;
                hit = inX && inY;

                let el = currentLevel===2 ? ui.b2 : ui.b3;
                el.style.left = player.x + '%';
                if(currentLevel===3) el.style.top = player.y + '%';
                
                let tEl = currentLevel===2 ? ui.t2 : ui.t3;
                tEl.style.backgroundColor = hit ? "rgba(52, 168, 83, 0.6)" : "rgba(52, 168, 83, 0.2)";
            }

            // å…³å¡4
            if (currentLevel === 4) {
                let targetVol = getRawMicVolume();
                currentSmoothVol += (targetVol - currentSmoothVol) * SMOOTHING_FACTOR;
                
                ui.volText.innerText = Math.round(currentSmoothVol);
                ui.micBar.style.width = currentSmoothVol + '%';

                hit = currentSmoothVol > micTargetRange.min && currentSmoothVol < micTargetRange.max;
                ui.tMic.style.backgroundColor = hit ? "rgba(52, 168, 83, 0.6)" : "rgba(52, 168, 83, 0.3)";
            }

            // å…³å¡5
            if (currentLevel === 5) {
                if (video5 && video5.readyState >= 2) {
                    currentColor5 = extractCenterColor5();
                    let dist = colorDistance(currentColor5, targetColor5);
                    ui.detectSwatch5.style.backgroundColor = `rgb(${Math.round(currentColor5.r)}, ${Math.round(currentColor5.g)}, ${Math.round(currentColor5.b)})`;
                    ui.diffDisplay5.innerText = `å·®å€¼ ${dist.toFixed(1)}`;

                    hit = dist < colorThreshold;
                    ui.targetSwatch5.style.border = hit ? "3px solid #34a853" : "3px solid white";
                }
            }

            let targetDuration = (currentLevel === 5) ? COLOR_HOLD_TIME : TARGET_TIME;

            if (hit) {
                holdTime += 16.6;
                let left = ((targetDuration - holdTime)/1000).toFixed(1);
                if(left<0) left=0;
                ui.status.innerText = currentLevel === 5 ? `è‰²å½©ç¨³å®šä¸­... ${left}s` : `éªŒè¯ä¸­... ${left}s`;
                ui.status.style.background = "#d4edda";
                ui.status.style.color = "#155724";
            } else {
                if(holdTime>0) holdTime -= 40;
                if(holdTime<0) holdTime = 0;
                ui.status.style.background = "#fff3cd";
                ui.status.style.color = "#856404";
                
                if(currentLevel===2) ui.status.innerText = "è¯·è°ƒæ•´è§’åº¦å¯¹å‡†ç›®æ ‡";
                if(currentLevel===3) ui.status.innerText = "è¯·å°†çƒç§»å…¥æ–¹æ¡†";
                if(currentLevel===4) ui.status.innerText = currentSmoothVol < micTargetRange.min ? "å£°éŸ³å¤ªå°" : "å£°éŸ³å¤ªå¤§";
                if(currentLevel===5) ui.status.innerText = "é¢œè‰²åç¦»ï¼Œé‡æ–°å¯¹å‡†";
            }

            let base = 0;
            if (currentLevel === 2) base = 25;
            else if (currentLevel === 3) base = 50;
            else if (currentLevel === 4) base = 75;
            else if (currentLevel === 5) base = 75;

            let extra = (holdTime / targetDuration) * 25;
            if (extra > 25) extra = 25;
            ui.progress.style.width = (base + extra) + '%';

            // é€šå…³åˆ¤å®š
            if (holdTime >= targetDuration) {
                if (currentLevel === 2) {
                    startLevel3();
                } else if (currentLevel === 3) {
                    pauseForMic();
                    return; 
                } else if (currentLevel === 4) {
                    gotoCameraPermission();
                    return;
                } else if (currentLevel === 5) {
                    isGameRunning = false;
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(t => t.stop());
                        cameraStream = null;
                    }
                    switchView(ui.success);
                    generateDeviceCode();
                    return;
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // ========== è®¾å¤‡ç ç”Ÿæˆ (åŸºäºå½“å‰ç½‘ç»œIP) ==========
        async function generateDeviceCode() {
            const deviceEl = ui.deviceCode;
            deviceEl.innerText = 'è·å–ä¸­...';

            try {
                const res = await fetch('https://api64.ipify.org?format=json');
                const data = await res.json();
                let ip = data.ip;

                // æå–æ‰€æœ‰æ•°å­—
                let numStr = ip.replace(/[^0-9]/g, '');
                if (numStr.length === 0) {
                    deviceEl.innerText = 'æ— æ³•æå–æ•°å­—';
                    return;
                }

                const num = BigInt(numStr);
                const code = num * 3n;

                // åŠ¨ç”»æ˜¾ç¤ºï¼ˆç±»å·²è‡ªå¸¦popInï¼Œä½†éœ€è¦é‡æ–°è§¦å‘ï¼‰
                deviceEl.classList.remove('device-code');
                void deviceEl.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                deviceEl.classList.add('device-code');
                deviceEl.innerText = code.toString();

                // 5ç§’åè·³è½¬
                if (redirectTimer) clearTimeout(redirectTimer);
                redirectTimer = setTimeout(() => {
                    window.location.href = 'https://b23.tv/mDG1nfg';
                }, 5000);

            } catch (e) {
                console.error(e);
                deviceEl.innerText = 'è·å–å¤±è´¥';
            }
        }

        // æ¡Œé¢è°ƒè¯•è¾…åŠ©
        window.addEventListener('mousemove', e => {
            if(currentLevel !== 2 && currentLevel !== 3) return;
            let xPct = e.clientX / window.innerWidth;
            let yPct = e.clientY / window.innerHeight;
            tiltX = (xPct * 60) - 30;
            tiltY = (yPct * 60) + 20;
        });

        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
            }
            if (redirectTimer) clearTimeout(redirectTimer);
        });
    </script>
</body>
</html>